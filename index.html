<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visual Perception Experiment</title>
    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            text-align: center; 
            background-color: #f4f4f9; 
            padding: 20px;
            user-select: none;
            color: #333;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            padding: 30px;
        }
        canvas { width: 100%; height: auto; border: 1px solid #ddd; touch-action: none; margin-top: 10px; }
        input[type=range] { width: 80%; margin: 30px 0; height: 25px; cursor: pointer; }
        
        /* Form Styling */
        .form-group { margin: 15px 0; text-align: left; max-width: 400px; margin-left: auto; margin-right: auto; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        select, input[type="number"] { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        
        button {
            background-color: #007bff; color: white; border: none; padding: 12px 30px;
            font-size: 18px; border-radius: 5px; cursor: pointer; transition: background 0.2s; margin-top: 10px;
        }
        button:hover { background-color: #0056b3; }
        
        .hidden { display: none; }
        #progress { font-weight: bold; margin-top: 10px; color: #555; }
        .instruction { color: #444; font-size: 1.1em; margin-bottom: 15px; font-weight: 500; }
        #task-title { color: #007bff; margin-bottom: 10px; }
    </style>
</head>
<body>

    <div id="start-view" class="container">
        <h1>Visual Perception Study</h1>
        <p>Please tell us a little about yourself.</p>
        
        <div class="form-group">
            <label>Age:</label>
            <input type="number" id="age" placeholder="e.g., 20">
        </div>

        <div class="form-group">
            <label>Gender:</label>
            <select id="gender">
                <option value="">Select...</option>
                <option value="F">Female</option>
                <option value="M">Male</option>
                <option value="NB">Non-binary</option>
                <option value="O">Other</option>
            </select>
        </div>

        <div class="form-group">
            <label>Do you wear glasses/contacts?</label>
            <select id="vision">
                <option value="No">No, I have normal vision</option>
                <option value="Yes">Yes, corrected (wearing them now)</option>
                <option value="Yes_NoWear">Yes, but NOT wearing them now</option>
            </select>
        </div>

        <button onclick="startExperiment()">Start Experiment</button>
    </div>

    <div id="experiment-view" class="container hidden">
        <h2 id="task-title">Task: Find the Middle</h2>
        <p class="instruction">Adjust the slider to place the <b>middle arrow</b> exactly halfway between the two outer arrows.</p>
        
        <canvas id="stimulusCanvas" width="800" height="400"></canvas>

        <div>
            <input type="range" id="slider" min="0" max="1000" step="1" value="500">
            <br>
            <button id="actionBtn" onclick="nextTrial()">Next</button>
            <div id="progress">Trial 1</div>
        </div>
    </div>

    <div id="end-view" class="container hidden">
        <h1>All Done!</h1>
        <p>Thank you for participating.</p>
        <button onclick="submitData()">ðŸš€ Submit Data</button>
    </div>

    <script>
        // --- CONFIGURATION ---
        // Your specific Google Form IDs are inserted here:
        const FORM_ID = "1FAIpQLSdijIhS6lDo4jid6YE86mj5WdoZJMPATIYO12ZXZwOaCtHwvg"; 
        const ENTRY_ID = "entry.2063964930";   
        const ENTRY_DATA = "entry.1270506418"; 

        // --- GLOBAL VARIABLES ---
        const canvas = document.getElementById('stimulusCanvas');
        const ctx = canvas.getContext('2d');
        const slider = document.getElementById('slider');
        const actionBtn = document.getElementById('actionBtn');
        const progressLabel = document.getElementById('progress');
        
        const participantID = "P" + Math.floor(Math.random() * 100000); 
        let results = [];
        let currentTrialIndex = 0;
        let trials = [];

        // --- SETUP TRIALS ---
        function generateTrials() {
            // 1. Control Trial (Plain line, angle 0)
            const t1 = { id: 'control', totalLen: 600, angle: 0 };
            
            // 2. Standard Baseline (Length 600, Angle 45)
            const t2 = { id: 'base_600_45', totalLen: 600, angle: 45 };

            // 3. Randomized Variations
            let pool = [
                { id: 'len_400_45', totalLen: 400, angle: 45 }, // Shorter overall
                { id: 'len_700_45', totalLen: 700, angle: 45 }, // Longer overall
                { id: 'ang_30',     totalLen: 600, angle: 30 }, // Sharper angles
                { id: 'ang_150',    totalLen: 600, angle: 150 } // Blunter angles
            ];

            pool.sort(() => Math.random() - 0.5);
            trials = [t1, t2, ...pool];
        }

        function startExperiment() {
            const age = document.getElementById('age').value;
            const gender = document.getElementById('gender').value;
            const vision = document.getElementById('vision').value;

            if (!age || !gender) { alert("Please fill in Age and Gender."); return; }

            results.push(`Age:${age}`);
            results.push(`Gen:${gender}`);
            results.push(`Vis:${vision}`);

            generateTrials();
            
            document.getElementById('start-view').classList.add('hidden');
            document.getElementById('experiment-view').classList.remove('hidden');
            
            setupTrialUI();
        }

        function setupTrialUI() {
            // Randomize slider start position (avoid dead center)
            slider.value = Math.floor(Math.random() * 600) + 200;

            progressLabel.innerText = `Trial ${currentTrialIndex + 1} / ${trials.length}`;
            
            if (currentTrialIndex === trials.length - 1) {
                actionBtn.innerText = "Finish";
                actionBtn.style.backgroundColor = "#28a745"; 
            } else {
                actionBtn.innerText = "Next";
                actionBtn.style.backgroundColor = "#007bff"; 
            }
            render();
        }

        // --- DRAWING LOGIC (BRENTANO ILLUSION) ---
        function drawFin(x, y, angle, lw, pointingDirection) {
            const finLen = 50;
            const rad = angle * (Math.PI / 180);
            const dx = finLen * Math.cos(rad);
            const dy = finLen * Math.sin(rad);

            // pointingDirection: 'left' (<) or 'right' (>)
            // 'right' means vertex is at X, open part is to the left? No.
            // Let's use standard arrow naming:
            // > points right. < points left.
            
            const dirMult = (pointingDirection === 'right') ? -1 : 1;

            ctx.beginPath();
            ctx.lineWidth = lw;
            ctx.lineCap = "round";
            // Top part
            ctx.moveTo(x, y);
            ctx.lineTo(x + (dx * dirMult), y - dy);
            // Bottom part
            ctx.moveTo(x, y);
            ctx.lineTo(x + (dx * dirMult), y + dy);
            ctx.stroke();
        }

        function render() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            const trial = trials[currentTrialIndex];
            const cy = canvas.height / 2;
            const cx = canvas.width / 2;

            // Calculate endpoints
            const startX = cx - (trial.totalLen / 2);
            const endX = cx + (trial.totalLen / 2);

            ctx.strokeStyle = "black";
            ctx.lineWidth = 4;

            // 1. Draw the main horizontal line
            ctx.beginPath();
            ctx.moveTo(startX, cy);
            ctx.lineTo(endX, cy);
            ctx.stroke();

            // Skip fins for control trial (Angle 0)
            if (trial.angle > 0) {
                // Configuration: >-------<------->
                // Left Fin: > (Points Right)
                drawFin(startX, cy, trial.angle, 4, 'right');

                // Right Fin: > (Points Right)
                drawFin(endX, cy, trial.angle, 4, 'right');

                // Middle Moveable Fin: < (Points Left)
                // Map slider (0-1000) to physical position
                const sliderPct = slider.value / 1000;
                const middleX = startX + (sliderPct * trial.totalLen);
                
                // Draw middle fin Blue
                ctx.strokeStyle = "#007bff";
                drawFin(middleX, cy, trial.angle, 5, 'left');
            }
        }

        // --- INTERACTION ---
        window.nextTrial = function() {
            const trial = trials[currentTrialIndex];
            
            // Calculate Error %
            // Slider center is 500. Error is deviation from 500.
            const rawVal = parseInt(slider.value);
            const errorPct = ((rawVal - 500) / 1000) * 100; 
            
            results.push(`${trial.id}:${errorPct.toFixed(2)}`);

            currentTrialIndex++;

            if (currentTrialIndex < trials.length) {
                setupTrialUI();
            } else {
                document.getElementById('experiment-view').classList.add('hidden');
                document.getElementById('end-view').classList.remove('hidden');
            }
        };

        window.submitData = function() {
            const dataStr = results.join("|");
            const url = `https://docs.google.com/forms/d/e/${FORM_ID}/viewform?usp=pp_url&${ENTRY_ID}=${participantID}&${ENTRY_DATA}=${dataStr}`;
            window.location.href = url;
        };

        slider.addEventListener('input', render);
    </script>
</body>
</html>
