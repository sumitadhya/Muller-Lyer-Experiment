<script>
    const FORM_ID = "1FAIpQLSdijIhS6lDo4jid6YE86mj5WdoZJMPATIYO12ZXZwOaCtHwvg";
    const ENTRY_ID = "entry.2063964930";   
    const ENTRY_DATA = "entry.1270506418"; 

    const canvas = document.getElementById('stimulusCanvas');
    const ctx = canvas.getContext('2d');
    const slider = document.getElementById('slider');
    const progressLabel = document.getElementById('progress');
    
    const participantID = "User_" + Math.floor(Math.random() * 10000);
    
    // Configured for exactly one trial 
    const trials = [{ angle: 45, refLen: 300 }];
    let currentTrialIndex = 0;
    let results = [];

    function drawArrow(y, length, angle, finDirection) {
        const centerX = canvas.width / 2;
        const startX = centerX - (length / 2);
        const endX = centerX + (length / 2);
        const finLength = 50; 

        ctx.lineWidth = 4;
        ctx.lineCap = "round";
        ctx.strokeStyle = "black";
        ctx.beginPath();
        
        ctx.moveTo(startX, y);
        ctx.lineTo(endX, y);

        const rad = angle * (Math.PI / 180);
        const dx = finLength * Math.cos(rad);
        const dy = finLength * Math.sin(rad);

        let leftDir = (finDirection === 'outward') ? -1 : 1; 
        ctx.moveTo(startX, y);
        ctx.lineTo(startX + (dx * leftDir), y - dy);
        ctx.moveTo(startX, y);
        ctx.lineTo(startX + (dx * leftDir), y + dy);

        let rightDir = (finDirection === 'outward') ? 1 : -1;
        ctx.moveTo(endX, y);
        ctx.lineTo(endX + (dx * rightDir), y - dy);
        ctx.moveTo(endX, y);
        ctx.lineTo(endX + (dx * rightDir), y + dy);

        ctx.stroke();
    }

    function render() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        const trial = trials[currentTrialIndex];

        // Reference: Outward-pointing arrows 
        drawArrow(150, trial.refLen, trial.angle, 'outward');

        // Adjustable: Inward-pointing arrows 
        const userLength = parseInt(slider.value);
        drawArrow(350, userLength, trial.angle, 'inward');
    }

    slider.addEventListener('input', render);

    function nextTrial() {
        const trial = trials[currentTrialIndex];
        const userLength = parseInt(slider.value);
        const error = ((userLength - trial.refLen) / trial.refLen) * 100;
        
        results.push(`${trial.angle}:${error.toFixed(1)}`);
        endExperiment();
    }

    function endExperiment() {
        document.getElementById('experiment-view').classList.add('hidden');
        document.getElementById('end-view').classList.remove('hidden');
    }

    function submitData() {
        const finalDataString = results.join("|");
        const url = `https://docs.google.com/forms/d/e/${FORM_ID}/viewform?usp=pp_url&${ENTRY_ID}=${participantID}&${ENTRY_DATA}=${finalDataString}`;
        window.location.href = url;
    }

    progressLabel.innerText = "Trial 1 / 1";
    render();
</script>
