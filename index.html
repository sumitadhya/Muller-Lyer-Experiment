<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Müller-Lyer — Single Trial</title>
  <style>
    body{font-family:sans-serif;text-align:center;background:#f7f7f7;padding:20px}
    canvas{background:white;border:1px solid #ccc;display:block;margin:12px auto}
    #controls{margin-top:12px}
    button{padding:10px 14px;font-size:16px;border-radius:6px;border:0;background:#007bff;color:#fff;cursor:pointer}
    button:disabled{background:#9bbff0;cursor:default}
    #status{font-weight:600;margin-bottom:6px}
  </style>
</head>
<body>
  <h2>Müller-Lyer — Single Trial</h2>
  <div id="status">Adjust the bottom line until it looks equal to the top line.</div>
  <canvas id="stimulusCanvas" width="700" height="460"></canvas>
  <div id="controls">
    <input id="slider" type="range" min="50" max="650" value="200" style="width:420px">
    <br/><br/>
    <button id="submitBtn">Submit</button>
  </div>

<script>
  const FORM_ID = "YOUR_FORM_ID_HERE";
  const ENTRY_PID = "entry.YOUR_PID_ENTRY";
  const ENTRY_DATA = "entry.YOUR_DATA_ENTRY";
  const canvas = document.getElementById('stimulusCanvas');
  const ctx = canvas.getContext('2d');
  const slider = document.getElementById('slider');
  const submitBtn = document.getElementById('submitBtn');
  const status = document.getElementById('status');
  const participantID = "P_" + Math.floor(Math.random()*1000000);
  const trial = { angle: 45, refLen: 300 };
  slider.min = Math.max(20, Math.floor(trial.refLen * 0.4));
  slider.max = Math.floor(trial.refLen * 2.0);
  slider.value = Math.floor(trial.refLen * (1 + (Math.random()*0.3 - 0.15)));
  function drawArrow(y, length, angle, finDirection){
    const centerX = canvas.width/2;
    const startX = centerX - (length/2);
    const endX = centerX + (length/2);
    const finLength = 40;
    ctx.lineWidth = 4;
    ctx.lineCap = "round";
    ctx.strokeStyle = "black";
    ctx.beginPath();
    ctx.moveTo(startX, y);
    ctx.lineTo(endX, y);
    ctx.stroke();
    const rad = angle * (Math.PI/180);
    const dx = finLength * Math.cos(rad);
    const dy = finLength * Math.sin(rad);
    let leftDir = (finDirection === 'outward') ? -1 : 1;
    ctx.beginPath();
    ctx.moveTo(startX, y);
    ctx.lineTo(startX + (dx * leftDir), y - dy);
    ctx.moveTo(startX, y);
    ctx.lineTo(startX + (dx * leftDir), y + dy);
    ctx.stroke();
    let rightDir = (finDirection === 'outward') ? 1 : -1;
    ctx.beginPath();
    ctx.moveTo(endX, y);
    ctx.lineTo(endX + (dx * rightDir), y - dy);
    ctx.moveTo(endX, y);
    ctx.lineTo(endX + (dx * rightDir), y + dy);
    ctx.stroke();
  }
  function render(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    drawArrow(140, trial.refLen, trial.angle, 'outward');
    const userLen = parseInt(slider.value,10);
    drawArrow(320, userLen, trial.angle, 'inward');
  }
  slider.addEventListener('input', render);
  submitBtn.addEventListener('click', () => {
    submitBtn.disabled = true;
    slider.disabled = true;
    status.innerText = "Preparing submission...";
    const userLen = parseInt(slider.value,10);
    const errorPct = ((userLen - trial.refLen) / trial.refLen) * 100;
    const dataString = `angle=${trial.angle};ref=${trial.refLen};user=${userLen};err=${errorPct.toFixed(2)}`;
    const pidEncoded = encodeURIComponent(participantID);
    const dataEncoded = encodeURIComponent(dataString);
    const prefillURL = `https://docs.google.com/forms/d/e/${FORM_ID}/viewform?usp=pp_url&${ENTRY_PID}=${pidEncoded}&${ENTRY_DATA}=${dataEncoded}`;
    window.location.href = prefillURL;
  });
  render();
</script>
</body>
</html>
