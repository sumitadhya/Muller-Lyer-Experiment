<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The MÃ¼ller-Lyer Experiment</title>
    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            text-align: center; 
            background-color: #f4f4f9; 
            padding: 20px;
            user-select: none;
            color: #333;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            padding: 30px;
        }
        canvas { width: 100%; height: auto; border: 1px solid #ddd; touch-action: none; margin-top: 10px; }
        input[type=range] { width: 80%; margin: 20px 0; height: 25px; cursor: pointer; }
        
        /* Form Styling */
        .form-group { margin: 15px 0; text-align: left; max-width: 400px; margin-left: auto; margin-right: auto; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        select, input[type="number"], input[type="text"] { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        
        button {
            background-color: #007bff; color: white; border: none; padding: 12px 30px;
            font-size: 18px; border-radius: 5px; cursor: pointer; transition: background 0.2s; margin-top: 10px;
        }
        button:hover { background-color: #0056b3; }
        
        .hidden { display: none; }
        #progress { font-weight: bold; margin-top: 10px; color: #555; }
        .instruction { color: #666; font-size: 1.1em; margin-bottom: 15px; min-height: 1.5em; }
        h2 { margin-top: 0; }
    </style>
</head>
<body>

    <div id="start-view" class="container">
        <h1>The MÃ¼ller-Lyer Experiment </h1>
        <p>Please answer a few questions before we begin.</p>
        
        <div class="form-group">
            <label>Name:</label>
            <input type="text" id="fullname" placeholder="Enter your name">
        </div>

        <div class="form-group">
            <label>Age:</label>
            <input type="number" id="age" placeholder="e.g., 20">
        </div>

        <div class="form-group">
            <label>Gender:</label>
            <select id="gender">
                <option value="">Select...</option>
                <option value="F">Female</option>
                <option value="M">Male</option>
                <option value="NB">Non-binary</option>
                <option value="O">Other</option>
            </select>
        </div>

        <div class="form-group">
            <label>Do you wear glasses/contacts?</label>
            <select id="vision">
                <option value="No">No, I have normal vision</option>
                <option value="Yes">Yes, corrected (wearing them now)</option>
                <option value="Yes_NoWear">Yes, but NOT wearing them now</option>
            </select>
        </div>

        <button onclick="startExperiment()">Start Experiment</button>
    </div>

    <div id="experiment-view" class="container hidden">
        <h2 id="task-title">Task</h2>
        <p id="instruction-text" class="instruction">Loading...</p>
        
        <canvas id="stimulusCanvas" width="800" height="500"></canvas>

        <div>
            <input type="range" id="slider" min="0" max="1000" step="1" value="500">
            <br>
            <button id="actionBtn" onclick="nextTrial()">Next</button>
            <div id="progress">Trial 1</div>
        </div>
    </div>

    <div id="end-view" class="container hidden">
        <h1>All Done!</h1>
        <p>Thank you for participating.</p>
        <p>Please click below to submit your results.</p>
        <button onclick="submitData()">ðŸš€ Submit Data</button>
    </div>

    <script>
        // ==========================================
        // CONFIGURATION: GOOGLE FORM IDs
        // ==========================================
        const FORM_ID = "1FAIpQLSdijIhS6lDo4jid6YE86mj5WdoZJMPATIYO12ZXZwOaCtHwvg";
        
        const FIELD_IDS = {
            // Demographics
            'UserID':    'entry.339043380',
            'Name':      'entry.1879181318',
            'Age':       'entry.2026698951',
            'Gender':    'entry.1653629598',
            'Vision':    'entry.997778295',

            // Trial Errors
            'control':   'entry.1644266009',
            'baseline':  'entry.1058461495',
            'len_150':   'entry.1387334295',
            'len_350':   'entry.473230365',
            'thick_1px': 'entry.1255135971',
            'thick_5px': 'entry.449245928',
            'fins_2':    'entry.966390178',
            'ang_30':    'entry.1164651863',
            'ang_150':   'entry.635217377',
            'brentano':  'entry.912805463'
        };
        // ==========================================

        const canvas = document.getElementById('stimulusCanvas');
        const ctx = canvas.getContext('2d');
        const slider = document.getElementById('slider');
        const actionBtn = document.getElementById('actionBtn');
        const progressLabel = document.getElementById('progress');
        const instructionText = document.getElementById('instruction-text');
        const taskTitle = document.getElementById('task-title');
        
        let participantID = ""; 
        let userData = {}; 
        let trialResults = {}; 
        let currentTrialIndex = 0;
        let trials = [];

        // --- SETUP TRIALS ---
        function generateTrials() {
            // 1. FIXED: Control Trial
            const t1 = { id: 'control', type: 'match', refLen: 250, lw: 3, fins: 0, angle: 0 };
            
            // 2. FIXED: Baseline Standard
            const t2 = { id: 'baseline', type: 'match', refLen: 250, lw: 3, fins: 1, angle: 45 };

            // 3. RANDOMIZED POOL
            let pool = [
                // Length Variations
                { id: 'len_150',   type: 'match', refLen: 150, lw: 3, fins: 1, angle: 45 },
                { id: 'len_350',   type: 'match', refLen: 350, lw: 3, fins: 1, angle: 45 },
                // Thickness Variations
                { id: 'thick_1px', type: 'match', refLen: 250, lw: 1, fins: 1, angle: 45 },
                { id: 'thick_5px', type: 'match', refLen: 250, lw: 5, fins: 1, angle: 45 },
                // Double Fins
                { id: 'fins_2',    type: 'match', refLen: 250, lw: 3, fins: 2, angle: 45 },
                // Shape (Angle) Variations
                { id: 'ang_30',    type: 'match', refLen: 250, lw: 3, fins: 1, angle: 30 },
                { id: 'ang_150',   type: 'match', refLen: 250, lw: 3, fins: 1, angle: 150 },
                // Brentano Trial
                { id: 'brentano',  type: 'midpoint', totalLen: 600, lw: 3, angle: 45 }
            ];

            // Shuffle the pool
            pool.sort(() => Math.random() - 0.5);

            // Combine
            trials = [t1, t2, ...pool];
        }

        // --- STATE MANAGEMENT ---
        function startExperiment() {
            const name = document.getElementById('fullname').value.trim();
            const age = document.getElementById('age').value;
            const gender = document.getElementById('gender').value;
            const vision = document.getElementById('vision').value;

            if (!name || !age || !gender) {
                alert("Please fill in Name, Age, and Gender.");
                return;
            }

            // Generate ID: RandomNumber only (e.g., ID_93821)
            participantID = "ID_" + Math.floor(Math.random() * 100000);

            // Save demographics
            userData = {
                'UserID': participantID,
                'Name': name,
                'Age': age,
                'Gender': gender,
                'Vision': vision
            };

            generateTrials();
            
            document.getElementById('start-view').classList.add('hidden');
            document.getElementById('experiment-view').classList.remove('hidden');
            
            setupTrialUI();
        }

        function setupTrialUI() {
            const trial = trials[currentTrialIndex];
            
            progressLabel.innerText = `Trial ${currentTrialIndex + 1} / ${trials.length}`;
            
            if (trial.type === 'midpoint') {
                // Brentano Trial
                taskTitle.innerText = "Task: Find the Center";
                instructionText.innerHTML = "Adjust the slider to place the <b>middle arrow</b> exactly halfway between the two outer arrows.";
                slider.min = 0;
                slider.max = 1000;
                
                // Force bad start (Left or Right side)
                slider.value = Math.random() > 0.5 ? 200 : 800; 

            } else {
                // Matching Trial
                taskTitle.innerText = "Task: Match Length";
                instructionText.innerHTML = "Drag the slider until the <b>bottom line</b> looks exactly as long as the <b>top line</b>.";
                slider.min = 50;
                slider.max = 750;
                
                // Force bad start (50% or 150% of target)
                const multiplier = Math.random() > 0.5 ? 0.5 : 1.5;
                slider.value = trial.refLen * multiplier;
            }

            if (currentTrialIndex === trials.length - 1) {
                actionBtn.innerText = "Finish";
                actionBtn.style.backgroundColor = "#28a745"; 
            } else {
                actionBtn.innerText = "Next";
                actionBtn.style.backgroundColor = "#007bff"; 
            }

            render();
        }

        // --- DRAWING LOGIC ---
        function drawFin(x, y, angle, lw, direction) {
            const finLen = 50;
            const rad = angle * (Math.PI / 180);
            const dx = finLen * Math.cos(rad);
            const dy = finLen * Math.sin(rad);
            
            const dirMult = (direction === 'right') ? -1 : 1;

            ctx.beginPath();
            ctx.lineWidth = lw;
            ctx.lineCap = "round";
            ctx.strokeStyle = "black"; // All arrows black
            
            ctx.moveTo(x, y);
            ctx.lineTo(x + (dx * dirMult), y - dy);
            ctx.moveTo(x, y);
            ctx.lineTo(x + (dx * dirMult), y + dy);
            ctx.stroke();
        }

        function drawMatchTrial(trial) {
            const cx = canvas.width / 2;
            
            const drawLineWithFins = (y, len, isInward) => {
                const startX = cx - (len / 2);
                const endX = cx + (len / 2);
                
                ctx.lineWidth = trial.lw;
                ctx.strokeStyle = "black";
                ctx.beginPath();
                ctx.moveTo(startX, y);
                ctx.lineTo(endX, y);
                ctx.stroke();

                if (trial.fins > 0) {
                    const leftDir = isInward ? 'left' : 'right';
                    const rightDir = isInward ? 'right' : 'left';

                    drawFin(startX, y, trial.angle, trial.lw, leftDir);
                    drawFin(endX, y, trial.angle, trial.lw, rightDir);

                    if (trial.fins === 2) {
                        const offset = 20; // Distance inside the main vertices
    // Left secondary fin: moves +20px (right) from start
                        drawFin(startX + offset, y, trial.angle, trial.lw, leftDir);
    // Right secondary fin: moves -20px (left) from end
                        drawFin(endX - offset, y, trial.angle, trial.lw, rightDir);
                    }
                }
            };

            // Top (Reference): Outward (> <)
            drawLineWithFins(150, trial.refLen, false);
            // Bottom (User): Inward (< >)
            const userLen = parseInt(slider.value);
            drawLineWithFins(350, userLen, true);
        }

        function drawBrentanoTrial(trial) {
            const cx = canvas.width / 2;
            const cy = canvas.height / 2;
            const startX = cx - (trial.totalLen / 2);
            const endX = cx + (trial.totalLen / 2);

            ctx.lineWidth = trial.lw;
            ctx.strokeStyle = "black";
            
            // Main Line
            ctx.beginPath();
            ctx.moveTo(startX, cy);
            ctx.lineTo(endX, cy);
            ctx.stroke();

            // Fixed Ends: > ... > (Both point Right)
            drawFin(startX, cy, trial.angle, trial.lw, 'right');
            drawFin(endX, cy, trial.angle, trial.lw, 'right');

            // Moving Middle: < (Points Left)
            const pct = slider.value / 1000;
            const middleX = startX + (pct * trial.totalLen);
            
            // Draw Middle Fin (Black)
            drawFin(middleX, cy, trial.angle, trial.lw, 'left');
        }

        function render() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            const trial = trials[currentTrialIndex];

            if (trial.type === 'midpoint') {
                drawBrentanoTrial(trial);
            } else {
                drawMatchTrial(trial);
            }
        }

        // --- INTERACTION ---
        window.nextTrial = function() {
            const trial = trials[currentTrialIndex];
            let error;

            if (trial.type === 'midpoint') {
                // Brentano Error: Deviation from center (500)
                const val = parseInt(slider.value);
                error = ((val - 500) / 1000) * 100;
            } else {
                // Match Error: Deviation from Reference Length
                const userLen = parseInt(slider.value);
                error = ((userLen - trial.refLen) / trial.refLen) * 100;
            }

            // Store result
            trialResults[trial.id] = error.toFixed(2);
            
            currentTrialIndex++;

            if (currentTrialIndex < trials.length) {
                setupTrialUI();
            } else {
                document.getElementById('experiment-view').classList.add('hidden');
                document.getElementById('end-view').classList.remove('hidden');
            }
        };

        window.submitData = function() {
            // Build the URL based on the FIELD_IDS map
            let params = [];
            
            // Add Demographics
            for (let key in userData) {
                if (FIELD_IDS[key]) {
                    params.push(`${FIELD_IDS[key]}=${encodeURIComponent(userData[key])}`);
                }
            }
            
            // Add Trial Results
            for (let key in trialResults) {
                if (FIELD_IDS[key]) {
                    params.push(`${FIELD_IDS[key]}=${encodeURIComponent(trialResults[key])}`);
                }
            }

            const queryString = params.join("&");
            const url = `https://docs.google.com/forms/d/e/${FORM_ID}/viewform?usp=pp_url&${queryString}`;
            window.location.href = url;
        };

        slider.addEventListener('input', render);
    </script>
</body>
</html>
