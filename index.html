<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visual Perception Experiment</title>
    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            text-align: center; 
            background-color: #f4f4f9; 
            padding: 20px;
            user-select: none;
            color: #333;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            padding: 30px;
        }
        canvas { width: 100%; height: auto; border: 1px solid #ddd; touch-action: none; margin-top: 10px; }
        input[type=range] { width: 80%; margin: 20px 0; height: 25px; cursor: pointer; }
        
        /* Form Styling */
        .form-group { margin: 15px 0; text-align: left; max-width: 400px; margin-left: auto; margin-right: auto; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        select, input[type="number"] { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        
        button {
            background-color: #007bff; color: white; border: none; padding: 12px 30px;
            font-size: 18px; border-radius: 5px; cursor: pointer; transition: background 0.2s; margin-top: 10px;
        }
        button:hover { background-color: #0056b3; }
        
        .hidden { display: none; }
        #progress { font-weight: bold; margin-top: 10px; color: #555; }
        #instruction-text { font-size: 1.1em; color: #444; margin-bottom: 10px; min-height: 50px;}
    </style>
</head>
<body>

    <div id="start-view" class="container">
        <h1>Visual Perception Study</h1>
        <p>Please answer a few questions before we begin.</p>
        
        <div class="form-group">
            <label>Age:</label>
            <input type="number" id="age" placeholder="e.g., 20">
        </div>

        <div class="form-group">
            <label>Gender:</label>
            <select id="gender">
                <option value="">Select...</option>
                <option value="F">Female</option>
                <option value="M">Male</option>
                <option value="NB">Non-binary</option>
                <option value="O">Other</option>
            </select>
        </div>

        <div class="form-group">
            <label>Do you wear glasses/contacts?</label>
            <select id="vision">
                <option value="No">No, I have normal vision</option>
                <option value="Yes">Yes, corrected (wearing them now)</option>
                <option value="Yes_NoWear">Yes, but NOT wearing them now</option>
            </select>
        </div>

        <button onclick="startExperiment()">Start Experiment</button>
    </div>

    <div id="experiment-view" class="container hidden">
        <h2 id="task-title">Task</h2>
        <p id="instruction-text" class="instruction">Loading...</p>
        
        <canvas id="stimulusCanvas" width="800" height="500"></canvas>

        <div>
            <input type="range" id="slider" min="0" max="1000" step="1" value="500">
            <br>
            <button id="actionBtn" onclick="nextTrial()">Next</button>
            <div id="progress">Trial 1</div>
        </div>
    </div>

    <div id="end-view" class="container hidden">
        <h1>All Done!</h1>
        <p>Thank you for participating.</p>
        <p>Please click below to submit your results.</p>
        <button onclick="submitData()">ðŸš€ Submit Data</button>
    </div>

    <script>
        // --- CONFIGURATION ---
        const FORM_ID = "1FAIpQLSdijIhS6lDo4jid6YE86mj5WdoZJMPATIYO12ZXZwOaCtHwvg";
        const ENTRY_ID = "entry.2063964930";   
        const ENTRY_DATA = "entry.1270506418"; 

        // --- GLOBAL VARIABLES ---
        const canvas = document.getElementById('stimulusCanvas');
        const ctx = canvas.getContext('2d');
        const slider = document.getElementById('slider');
        const actionBtn = document.getElementById('actionBtn');
        const progressLabel = document.getElementById('progress');
        const instructionText = document.getElementById('instruction-text');
        const taskTitle = document.getElementById('task-title');
        
        const participantID = "P" + Math.floor(Math.random() * 100000); 
        let results = [];
        let currentTrialIndex = 0;
        let trials = [];

        // --- SETUP TRIALS ---
        function generateTrials() {
            // 1. FIXED: Control Trial (Index 0)
            const t1 = { id: 'control', type: 'match', refLen: 250, lw: 3, fins: 0, angle: 0 };
            
            // 2. FIXED: Baseline Standard (Index 1)
            const t2 = { id: 'baseline', type: 'match', refLen: 250, lw: 3, fins: 1, angle: 45 };

            // 3. NEW: Midpoint Trial (Index 2) - "Three Stylized Arrows" / Unidirectional
            // This renders >-----> and asks user to find center
            const t3 = { id: 'midpoint', type: 'midpoint', refLen: 400, lw: 3, fins: 1, angle: 45 };

            // 4. RANDOMIZED POOL
            let pool = [
                { id: 'len_150',   type: 'match', refLen: 150, lw: 3, fins: 1, angle: 45 },
                { id: 'len_350',   type: 'match', refLen: 350, lw: 3, fins: 1, angle: 45 },
                { id: 'thick_5px', type: 'match', refLen: 250, lw: 5, fins: 1, angle: 45 },
                { id: 'fins_2',    type: 'match', refLen: 250, lw: 3, fins: 2, angle: 45 },
                { id: 'ang_30',    type: 'match', refLen: 250, lw: 3, fins: 1, angle: 30 },
                { id: 'ang_150',   type: 'match', refLen: 250, lw: 3, fins: 1, angle: 150 }
            ];

            pool.sort(() => Math.random() - 0.5);

            // Combine: Control -> Baseline -> Midpoint -> Random Rest
            trials = [t1, t2, t3, ...pool];
        }

        function startExperiment() {
            const age = document.getElementById('age').value;
            const gender = document.getElementById('gender').value;
            const vision = document.getElementById('vision').value;

            if (!age || !gender) { alert("Please fill in Age and Gender."); return; }

            results.push(`Age:${age}`);
            results.push(`Gen:${gender}`);
            results.push(`Vis:${vision}`);

            generateTrials();
            
            document.getElementById('start-view').classList.add('hidden');
            document.getElementById('experiment-view').classList.remove('hidden');
            
            setupTrialUI();
        }

        function setupTrialUI() {
            const trial = trials[currentTrialIndex];
            
            // Reset Slider to random position
            slider.value = Math.floor(Math.random() * 800) + 100;

            if (trial.type === 'midpoint') {
                taskTitle.innerText = "Task: Find the Middle";
                instructionText.innerHTML = "Drag the slider to place the <b style='color:red'>RED MARKER</b> exactly in the <b>MIDPOINT</b> of the line.";
                // For midpoint, slider represents position (0 to 100% of line), so we map 0-1000 to 0-Length
            } else {
                taskTitle.innerText = "Task: Match Length";
                instructionText.innerHTML = "Drag the slider until the <b>bottom line</b> looks exactly as long as the <b>top line</b>.";
            }

            progressLabel.innerText = `Trial ${currentTrialIndex + 1} / ${trials.length}`;
            
            if (currentTrialIndex === trials.length - 1) {
                actionBtn.innerText = "Finish";
                actionBtn.style.backgroundColor = "#28a745"; 
            } else {
                actionBtn.innerText = "Next";
                actionBtn.style.backgroundColor = "#007bff"; 
            }
            render();
        }

        // --- DRAWING LOGIC ---
        function drawArrow(x, y, length, trial, finType) {
            // finType: 'outward' (> <), 'inward' (< >), 'right' (>>), 'left' (<<)
            const startX = x - (length / 2);
            const endX = x + (length / 2);
            const finLen = 50; 

            ctx.lineWidth = trial.lw;
            ctx.lineCap = "round";
            ctx.strokeStyle = "black";
            
            // Main Line
            ctx.beginPath();
            ctx.moveTo(startX, y);
            ctx.lineTo(endX, y);
            ctx.stroke();

            // Fins
            if (trial.fins > 0) {
                const rad = trial.angle * (Math.PI / 180);
                const dx = finLen * Math.cos(rad);
                const dy = finLen * Math.sin(rad);

                const drawFin = (cx, direction) => {
                    // direction: 1 (point right >), -1 (point left <)
                    ctx.beginPath();
                    ctx.moveTo(cx, y);
                    ctx.lineTo(cx + (dx * -direction), y - dy);
                    ctx.moveTo(cx, y);
                    ctx.lineTo(cx + (dx * -direction), y + dy);
                    ctx.stroke();
                };

                // Determine fin direction based on type
                let leftDir, rightDir;

                if (finType === 'unidirectional') {
                    // Both point RIGHT ( >-----> )
                    leftDir = 1;  
                    rightDir = 1; 
                } else if (finType === 'inward') {
                    // Tails (<--->) - Points IN
                    leftDir = 1; 
                    rightDir = -1;
                } else {
                    // Arrowheads (>---<) - Points OUT
                    leftDir = -1;
                    rightDir = 1;
                }

                drawFin(startX, leftDir);
                drawFin(endX, rightDir);

                if (trial.fins === 2) {
                    drawFin(startX + 20, leftDir);
                    drawFin(endX - 20, rightDir);
                }
            }
        }

        function render() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            const trial = trials[currentTrialIndex];
            const cx = canvas.width / 2;

            if (trial.type === 'midpoint') {
                // --- MIDPOINT TASK RENDER ---
                // Draw one line in center with Unidirectional arrows (>----->)
                const y = 250;
                drawArrow(cx, trial.refLen, trial, 'unidirectional');

                // Calculate Marker Position from Slider (0-1000 mapped to line length)
                const sliderPct = slider.value / 1000; 
                // Map to visual X coordinates (startX to endX)
                const startX = cx - (trial.refLen / 2);
                const currentX = startX + (sliderPct * trial.refLen);

                // Draw Red Marker
                ctx.beginPath();
                ctx.strokeStyle = "red";
                ctx.lineWidth = 4;
                ctx.moveTo(currentX, y - 30);
                ctx.lineTo(currentX, y + 30);
                ctx.stroke();

            } else {
                // --- MATCHING TASK RENDER ---
                // Reference (Top) - Outward (> <)
                drawArrow(cx, 150, trial.refLen, trial, 'outward');

                // Adjustable (Bottom) - Inward (< >)
                // Map slider 0-1000 to Length 50-750
                const userLen = 50 + (slider.value / 1000) * 700;
                drawArrow(cx, 350, userLen, trial, 'inward');
            }
        }

        // --- INTERACTION ---
        window.nextTrial = function() {
            const trial = trials[currentTrialIndex];
            
            if (trial.type === 'midpoint') {
                // Calculate Midpoint Error
                // Slider goes 0-1000. True center is 500.
                // Error = (UserVal - 500) / 500 * 100 (Percentage deviation from center)
                const rawVal = parseInt(slider.value);
                const error = ((rawVal - 500) / 500) * 100; 
                
                // If they place it towards the "tail" (left side in >-->), value < 500.
                results.push(`${trial.id}:${error.toFixed(1)}`);

            } else {
                // Calculate Length Error
                const userLen = 50 + (slider.value / 1000) * 700;
                const error = ((userLen - trial.refLen) / trial.refLen) * 100;
                results.push(`${trial.id}:${error.toFixed(1)}`);
            }
            
            currentTrialIndex++;

            if (currentTrialIndex < trials.length) {
                setupTrialUI();
            } else {
                document.getElementById('experiment-view').classList.add('hidden');
                document.getElementById('end-view').classList.remove('hidden');
            }
        };

        window.submitData = function() {
            const dataStr = results.join("|");
            const url = `https://docs.google.com/forms/d/e/${FORM_ID}/viewform?usp=pp_url&${ENTRY_ID}=${participantID}&${ENTRY_DATA}=${dataStr}`;
            window.location.href = url;
        };

        slider.addEventListener('input', render);
    </script>
</body>
</html>
